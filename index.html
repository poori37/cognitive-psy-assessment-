<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Syntax Card Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/ohm-js@16.4.0/dist/ohm.js"></script>
    <style>
        :root {
            --bg-dark: #1a202c;
            --bg-medium: #2d3748;
            --bg-light: #4a5568;
            --text-light: #e2e8f0;
            --text-dark: #a0aec0;
            --accent: #4fd1c5;
            --accent-dark: #38b2ac;
            --success: #68d391;
            --error: #fc8181;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--bg-medium);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--bg-light);
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            margin: 0;
        }

        header p {
            color: var(--text-dark);
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        #progress-tracker {
            margin-bottom: 1.5rem;
        }

        #progress-bar-container {
            width: 100%;
            background-color: var(--bg-dark);
            border-radius: 99px;
            height: 1rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-dark), var(--accent));
            border-radius: 99px;
            transition: width 0.5s ease-in-out;
        }
        
        #progress-text {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: var(--text-dark);
        }

        #challenge-display {
            background-color: rgba(0,0,0,0.2);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent);
        }

        #challenge-display h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .game-area {
            margin-bottom: 1.5rem;
        }

        .game-area h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dark);
            margin-bottom: 0.75rem;
        }
        
        .drop-zone {
            min-height: 80px;
            background-color: var(--bg-dark);
            border: 2px dashed var(--bg-light);
            border-radius: 0.5rem;
            padding: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .drop-zone.drag-over {
            border-color: var(--accent);
            background-color: #3c4a61;
        }

        .drop-zone:empty::before {
            content: 'Drag words here to form a sentence';
            color: var(--text-dark);
            width: 100%;
            text-align: center;
            font-style: italic;
        }

        .word-tile {
            padding: 0.5rem 1rem;
            background-color: var(--bg-light);
            border-radius: 0.25rem;
            cursor: grab;
            user-select: none;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            border-bottom: 3px solid rgba(0,0,0,0.3);
        }

        .word-tile.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Poppins', sans-serif;
        }

        #check-btn {
            background-color: var(--accent);
            color: var(--bg-dark);
        }
        #check-btn:hover {
            background-color: white;
        }
        #check-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #reset-btn {
            background-color: var(--bg-light);
            color: var(--text-light);
        }
        #reset-btn:hover {
            background-color: #5a6b87;
        }

        #feedback {
            min-height: 24px;
            margin-top: 1.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            transition: opacity 0.3s;
        }
        
        .feedback-correct {
            color: var(--success);
        }

        .feedback-incorrect {
            color: var(--error);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <header>
            <h1>The Syntax Card Game</h1>
            <p>Arrange the words to match the target sentence structure.</p>
        </header>

        <section id="progress-tracker">
            <div id="progress-text">
                <span id="level-counter">Level 1/50</span>
                <span id="score-counter">Score: 0</span>
            </div>
            <div id="progress-bar-container">
                <div id="progress-bar"></div>
            </div>
        </section>

        <main>
            <div id="challenge-display">
                <h2>TARGET: <span id="target-grammar"></span></h2>
            </div>
            
            <div class="game-area">
                <h3>Your Sentence</h3>
                <div id="sentence-area" class="drop-zone"></div>
            </div>
            
            <div class="game-area">
                <h3>Word Bank</h3>
                <div id="word-bank" class="drop-zone"></div>
            </div>

            <div id="controls">
                <button id="check-btn">Check Sentence</button>
                <button id="reset-btn">Reset</button>
            </div>

            <div id="feedback"></div>
        </main>
    </div>

    <!-- Ohm.js Grammar Definition -->
    <script type="ohm-js" id="grammar">
    SyntaxCardGame {
      // Top-level rules correspond to level targets
      S_V = Noun Verb
      Det_N_V = Det Noun Verb
      S_V_O = Noun Verb Noun
      S_V_Adv = Noun Verb Adv
      Det_Adj_N_V = Det Adj Noun Verb
      S_V_PP = Noun Verb Prep Det Noun
      S_V_O_PP = Noun Verb Noun Prep Det Noun
      S_V_Conj_V = Noun Verb Conj Verb
      Compound_S_V = Noun Conj Noun Verb
      S_V_O_Conj_S_V_O = Noun Verb Noun Conj Noun Verb Noun
      Question_V_S_O = Aux Noun Verb Noun
      Question_Wh_V_S = Wh Aux Noun Verb

      // Parts of Speech Definitions
      Noun = "noun"
      Verb = "verb"
      Det = "det"
      Adj = "adj"
      Adv = "adv"
      Prep = "prep"
      Conj = "conj"
      Aux = "aux"
      Wh = "wh"
    }
    </script>
    
    <script type="module">
        const levels = [
            // Levels 1-10: Basics (S-V, S-V-O)
            { rule: "S_V", words: [{word: "Birds", type: "Noun"}, {word: "fly", type: "Verb"}] },
            { rule: "Det_N_V", words: [{word: "The", type: "Det"}, {word: "sun", type: "Noun"}, {word: "shines", type: "Verb"}] },
            { rule: "S_V_O", words: [{word: "Cats", type: "Noun"}, {word: "chase", type: "Verb"}, {word: "mice", type: "Noun"}] },
            { rule: "S_V_Adv", words: [{word: "She", type: "Noun"}, {word: "sings", type: "Verb"}, {word: "loudly", type: "Adv"}] },
            { rule: "S_V", words: [{word: "Dogs", type: "Noun"}, {word: "bark", type: "Verb"}] },
            { rule: "Det_N_V", words: [{word: "A", type: "Det"}, {word: "boy", type: "Noun"}, {word: "runs", type: "Verb"}] },
            { rule: "S_V_O", words: [{word: "I", type: "Noun"}, {word: "read", type: "Verb"}, {word: "books", type: "Noun"}] },
            { rule: "S_V_Adv", words: [{word: "He", type: "Noun"}, {word: "works", type: "Verb"}, {word: "hard", type: "Adv"}] },
            { rule: "S_V_O", words: [{word: "They", type: "Noun"}, {word: "play", type: "Verb"}, {word: "games", type: "Noun"}] },
            { rule: "Det_N_V", words: [{word: "The", type: "Det"}, {word: "baby", type: "Noun"}, {word: "cries", type: "Verb"}] },
            // Levels 11-20: Adjectives & Prepositions
            { rule: "Det_Adj_N_V", words: [{word: "The", type: "Det"}, {word: "big", type: "Adj"}, {word: "dog", type: "Noun"}, {word: "barks", type: "Verb"}] },
            { rule: "S_V_PP", words: [{word: "He", type: "Noun"}, {word: "sits", type: "Verb"}, {word: "on", type: "Prep"}, {word: "the", type: "Det"}, {word: "chair", type: "Noun"}] },
            { rule: "Det_Adj_N_V", words: [{word: "A", type: "Det"}, {word: "red", type: "Adj"}, {word: "car", type: "Noun"}, {word: "drives", type: "Verb"}] },
            { rule: "S_V_O_PP", words: [{word: "She", type: "Noun"}, {word: "put", type: "Verb"}, {word: "keys", type: "Noun"}, {word: "in", type: "Prep"}, {word: "the", type: "Det"}, {word: "box", type: "Noun"}] },
            { rule: "Det_Adj_N_V", words: [{word: "The", type: "Det"}, {word: "tall", type: "Adj"}, {word: "tree", type: "Noun"}, {word: "grows", type: "Verb"}] },
            { rule: "S_V_PP", words: [{word: "Fish", type: "Noun"}, {word: "swim", type: "Verb"}, {word: "in", type: "Prep"}, {word: "the", type: "Det"}, {word: "sea", type: "Noun"}] },
            { rule: "Det_Adj_N_V", words: [{word: "A", type: "Det"}, {word: "happy", type: "Adj"}, {word: "child", type: "Noun"}, {word: "laughs", type: "Verb"}] },
            { rule: "S_V_O_PP", words: [{word: "He", type: "Noun"}, {word: "threw", type: "Verb"}, {word: "ball", type: "Noun"}, {word: "over", type: "Prep"}, {word: "the", type: "Det"}, {word: "fence", type: "Noun"}] },
            { rule: "Det_Adj_N_V", words: [{word: "The", type: "Det"}, {word: "cold", type: "Adj"}, {word: "wind", type: "Noun"}, {word: "blows", type: "Verb"}] },
            { rule: "S_V_PP", words: [{word: "We", type: "Noun"}, {word: "walk", type: "Verb"}, {word: "to", type: "Prep"}, {word: "the", type: "Det"}, {word: "park", type: "Noun"}] },
            // Levels 21-30: Conjunctions
            { rule: "S_V_Conj_V", words: [{word: "I", type: "Noun"}, {word: "read", type: "Verb"}, {word: "and", type: "Conj"}, {word: "write", type: "Verb"}] },
            { rule: "Compound_S_V", words: [{word: "Tom", type: "Noun"}, {word: "and", type: "Conj"}, {word: "Jerry", type: "Noun"}, {word: "run", type: "Verb"}] },
            { rule: "S_V_O_Conj_S_V_O", words: [{word: "She", type: "Noun"}, {word: "likes", type: "Verb"}, {word: "tea", type: "Noun"}, {word: "but", type: "Conj"}, {word: "he", type: "Noun"}, {word: "wants", type: "Verb"}, {word: "coffee", type: "Noun"}] },
            { rule: "S_V_Conj_V", words: [{word: "He", type: "Noun"}, {word: "sings", type: "Verb"}, {word: "and", type: "Conj"}, {word: "dances", type: "Verb"}] },
            { rule: "Compound_S_V", words: [{word: "You", type: "Noun"}, {word: "and", type: "Conj"}, {word: "I", type: "Noun"}, {word: "learn", type: "Verb"}] },
            { rule: "S_V_O_Conj_S_V_O", words: [{word: "Dogs", type: "Noun"}, {word: "bark", type: "Verb"}, {word: "loudly", type: "Adv"}, {word: "but", type: "Conj"}, {word: "cats", type: "Noun"}, {word: "prowl", type: "Verb"}, {word: "silently", type: "Adv"}] }, // Note: Adv not in rule, for simplicity.
            { rule: "S_V_Conj_V", words: [{word: "She", type: "Noun"}, {word: "fell", type: "Verb"}, {word: "but", type: "Conj"}, {word: "recovered", type: "Verb"}] },
            { rule: "Compound_S_V", words: [{word: "The", type: "Det"}, {word: "cat", type: "Noun"}, {word: "and", type: "Conj"}, {word: "dog", type: "Noun"}, {word: "play", type: "Verb"}] },
            { rule: "S_V_O_Conj_S_V_O", words: [{word: "We", type: "Noun"}, {word: "can", type: "Verb"}, {word: "win", type: "Noun"}, {word: "or", type: "Conj"}, {word: "we", type: "Noun"}, {word: "can", type: "Verb"}, {word: "lose", type: "Noun"}] },
            { rule: "S_V_Conj_V", words: [{word: "They", type: "Noun"}, {word: "work", type: "Verb"}, {word: "and", type: "Conj"}, {word: "succeed", type: "Verb"}] },
            // Levels 31-40: Questions
            { rule: "Question_V_S_O", words: [{word: "Do", type: "Aux"}, {word: "you", type: "Noun"}, {word: "like", type: "Verb"}, {word: "pizza", type: "Noun"}] },
            { rule: "Question_Wh_V_S", words: [{word: "When", type: "Wh"}, {word: "did", type: "Aux"}, {word: "they", type: "Noun"}, {word: "leave", type: "Verb"}] },
            { rule: "Question_V_S_O", words: [{word: "Can", type: "Aux"}, {word: "he", type: "Noun"}, {word: "speak", type: "Verb"}, {word: "French", type: "Noun"}] },
            { rule: "Question_Wh_V_S", words: [{word: "Where", type: "Wh"}, {word: "is", type: "Aux"}, {word: "the", type: "Det"}, {word: "party", type: "Noun"}] },
            { rule: "Question_V_S_O", words: [{word: "Will", type: "Aux"}, {word: "she", type: "Noun"}, {word: "call", type: "Verb"}, {word: "you", type: "Noun"}] },
            { rule: "Question_Wh_V_S", words: [{word: "Why", type: "Wh"}, {word: "are", type: "Aux"}, {word: "you", type: "Noun"}, {word: "late", type: "Adj"}] },
            { rule: "Question_V_S_O", words: [{word: "Have", type: "Aux"}, {word: "they", type: "Noun"}, {word: "eaten", type: "Verb"}, {word: "lunch", type: "Noun"}] },
            { rule: "Question_Wh_V_S", words: [{word: "Who", type: "Wh"}, {word: "ate", type: "Aux"}, {word: "the", type: "Det"}, {word: "cake", type: "Noun"}] },
            { rule: "Question_V_S_O", words: [{word: "Does", type: "Aux"}, {word: "it", type: "Noun"}, {word: "work", type: "Verb"}, {word: "now", type: "Adv"}] },
            { rule: "Question_Wh_V_S", words: [{word: "What", type: "Wh"}, {word: "is", type: "Aux"}, {word: "your", type: "Det"}, {word: "name", type: "Noun"}] },
            // Levels 41-50: More Complex
            { rule: "S_V_O_PP", words: [{word: "Artists", type: "Noun"}, {word: "paint", type: "Verb"}, {word: "pictures", type: "Noun"}, {word: "with", type: "Prep"}, {word: "great", type: "Adj"}, {word: "skill", type: "Noun"}] },
            { rule: "S_V_Adv", words: [{word: "Computers", type: "Noun"}, {word: "calculate", type: "Verb"}, {word: "quickly", type: "Adv"}] },
            { rule: "Det_Adj_N_V", words: [{word: "The", type: "Det"}, {word: "old", type: "Adj"}, {word: "castle", type: "Noun"}, {word: "stands", type: "Verb"}] },
            { rule: "S_V_O_PP", words: [{word: "She", type: "Noun"}, {word: "told", type: "Verb"}, {word: "a story", type: "Noun"}, {word: "to", type: "Prep"}, {word: "the", type: "Det"}, {word: "children", type: "Noun"}] },
            { rule: "S_V_Conj_V", words: [{word: "He", type: "Noun"}, {word: "tries", type: "Verb"}, {word: "but", type: "Conj"}, {word: "fails", type: "Verb"}] },
            { rule: "Question_V_S_O", words: [{word: "Did", type: "Aux"}, {word: "the", type: "Det"}, {word: "team", type: "Noun"}, {word: "win", type: "Verb"}, {word: "the", type: "Det"}, {word: "match", type: "Noun"}] },
            { rule: "Det_Adj_N_V", words: [{word: "A", type: "Det"}, {word: "brilliant", type: "Adj"}, {word: "idea", type: "Noun"}, {word: "emerged", type: "Verb"}] },
            { rule: "S_V_O_PP", words: [{word: "We", type: "Noun"}, {word: "received", type: "Verb"}, {word: "a letter", type: "Noun"}, {word: "from", type: "Prep"}, {word: "our", type: "Det"}, {word: "friends", type: "Noun"}] },
            { rule: "Compound_S_V", words: [{word: "Stars", type: "Noun"}, {word: "and", type: "Conj"}, {word: "planets", type: "Noun"}, {word: "shine", type: "Verb"}] },
            { rule: "S_V_O_Conj_S_V_O", words: [{word: "The", type: "Det"}, {word: "movie", type: "Noun"}, {word: "was", type: "Verb"}, {word: "long", type: "Adj"}, {word: "but", type: "Conj"}, {word: "it", type: "Noun"}, {word: "was", type: "Verb"}, {word: "exciting", type: "Adj"}] },
        ];

        let currentLevelIndex = 0;
        let score = 0;
        let draggedTile = null;

        // DOM Elements
        const levelCounter = document.getElementById('level-counter');
        const scoreCounter = document.getElementById('score-counter');
        const progressBar = document.getElementById('progress-bar');
        const targetGrammarEl = document.getElementById('target-grammar');
        const sentenceArea = document.getElementById('sentence-area');
        const wordBank = document.getElementById('word-bank');
        const checkBtn = document.getElementById('check-btn');
        const resetBtn = document.getElementById('reset-btn');
        const feedbackEl = document.getElementById('feedback');

        // Ohm.js setup
        const grammarText = document.getElementById('grammar').textContent;
        const grammar = ohm.grammar(grammarText);

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function loadLevel() {
            if (currentLevelIndex >= levels.length) {
                showGameComplete();
                return;
            }

            const level = levels[currentLevelIndex];
            
            // Clear previous level
            sentenceArea.innerHTML = '';
            wordBank.innerHTML = '';
            feedbackEl.textContent = '';
            feedbackEl.className = '';
            checkBtn.disabled = true;

            // Update UI
            targetGrammarEl.textContent = level.rule.replace(/_/g, ' - ');
            updateProgress();

            // Populate word bank
            const wordsToShuffle = [...level.words];
            shuffleArray(wordsToShuffle);
            wordsToShuffle.forEach(wordData => {
                const tile = createWordTile(wordData);
                wordBank.appendChild(tile);
            });
        }
        
        function updateProgress() {
            levelCounter.textContent = `Level ${currentLevelIndex + 1}/${levels.length}`;
            scoreCounter.textContent = `Score: ${score}`;
            const progressPercentage = currentLevelIndex / levels.length * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }


        function createWordTile(wordData) {
            const tile = document.createElement('div');
            tile.className = 'word-tile';
            tile.textContent = wordData.word;
            tile.dataset.type = wordData.type;
            tile.draggable = true;
            
            tile.addEventListener('dragstart', handleDragStart);
            tile.addEventListener('dragend', handleDragEnd);

            return tile;
        }

        function checkSentence() {
            const wordsInSentence = Array.from(sentenceArea.children);
            if (wordsInSentence.length === 0) return;

            const level = levels[currentLevelIndex];
            
            // Normalize the type sequence to lowercase to match the grammar definition
            const typeSequence = wordsInSentence.map(tile => tile.dataset.type.toLowerCase()).join(' ');
            
            const levelRule = level.rule;
            const targetWordCount = level.words.length;

            const match = grammar.match(typeSequence, levelRule);

            if (match.succeeded()) {
                feedbackEl.textContent = 'Correct! Structure matched.';
                feedbackEl.className = 'feedback-correct';
                score += 10;
                currentLevelIndex++;
                saveState(); // Save progress after level completion
                updateProgress();
                setTimeout(loadLevel, 1500);
            } else {
                feedbackEl.className = 'feedback-incorrect';
                if (wordBank.children.length > 0) {
                     feedbackEl.textContent = `You haven't used all the words yet. This level requires ${targetWordCount} words.`;
                } else if (wordsInSentence.length === targetWordCount) {
                    // Word count is correct, so the order must be wrong.
                    const friendlyRule = levelRule.replace(/_/g, ' - ');
                    feedbackEl.textContent = `The word order is incorrect. Remember the target structure: ${friendlyRule}.`;
                } else {
                    // Fallback generic error
                    feedbackEl.textContent = 'That structure is not quite right. Try again!';
                }
            }
        }
        
        function resetLevel() {
            loadLevel();
        }

        function showGameComplete() {
            document.getElementById('game-container').innerHTML = `
                <header>
                    <h1>Congratulations!</h1>
                    <p>You have completed all ${levels.length} levels.</p>
                    <h2>Final Score: ${score}</h2>
                    <button id="restart-btn" style="margin-top: 1rem; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: 600; font-size: 1rem; cursor: pointer; background-color: var(--accent); color: var(--bg-dark);">Play Again</button>
                </header>
            `;
            document.getElementById('restart-btn').addEventListener('click', () => {
                localStorage.removeItem('syntaxGameState');
                window.location.reload();
            });
        }

        function saveState() {
            localStorage.setItem('syntaxGameState', JSON.stringify({ currentLevelIndex, score }));
        }

        function loadState() {
            const savedState = localStorage.getItem('syntaxGameState');
            if (savedState) {
                const { currentLevelIndex: savedLevel, score: savedScore } = JSON.parse(savedState);
                // Basic validation to prevent bad state
                if (typeof savedLevel === 'number' && typeof savedScore === 'number') {
                    currentLevelIndex = savedLevel;
                    score = savedScore;
                }
            }
        }
        
        // --- Drag and Drop Handlers ---
        
        function handleDragStart(e) {
            draggedTile = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedTile = null;
        }

        function getDragAfterElement(container, x, y) {
            const draggableElements = [...container.querySelectorAll('.word-tile:not(.dragging)')];

            // Find the child element that is geometrically closest to the cursor
            const closest = draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                // Calculate distance from cursor to the center of the child element
                const distance = Math.hypot(x - (box.left + box.width / 2), y - (box.top + box.height / 2));
                if (distance < closest.distance) {
                    return { distance, element: child };
                } else {
                    return closest;
                }
            }, { distance: Number.POSITIVE_INFINITY });

            if (closest.element) {
                const box = closest.element.getBoundingClientRect();
                // If cursor is horizontally past the center of the closest element, insert after it
                if (x > box.left + box.width / 2) {
                    return closest.element.nextElementSibling;
                } else {
                    // Otherwise, insert before it
                    return closest.element;
                }
            } else {
                // If container is empty or no closest element found, append to the end
                return null;
            }
        }


        // Event Listeners
        [sentenceArea, wordBank].forEach(zone => {
            zone.addEventListener('dragover', e => {
                e.preventDefault(); // This is necessary to allow a drop
                zone.classList.add('drag-over');
                
                if (draggedTile) {
                    const afterElement = getDragAfterElement(zone, e.clientX, e.clientY);
                    if (afterElement == null) {
                        zone.appendChild(draggedTile);
                    } else {
                        zone.insertBefore(draggedTile, afterElement);
                    }
                }
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                // The element is already in place thanks to the 'dragover' handler.
                // We just need to finalize the state.
                checkBtn.disabled = sentenceArea.children.length === 0;
            });
        });

        checkBtn.addEventListener('click', checkSentence);
        resetBtn.addEventListener('click', resetLevel);
        
        // Save progress before leaving
        window.addEventListener('beforeunload', saveState);

        // Initial Load
        loadState();
        loadLevel();
    </script>
</body>
</html>